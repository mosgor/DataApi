# DataProcessor

Этот сервис отвеает за приведение данных в удобный формат для моделей данных. Сервис получает шаблон, на основе которого меняет формат данных. Пользователь отправляет шаблон, с которым уже работает сервис.

## Как происходит получение данных?

Для получения данных используется протокол передачи данных gRPC. В файле `main.py` запускается сервер для получения данных с `DataProcessorServicer`.

`DataProcessorServicer` описан в файле `data_processor.py`. С `SourceManager` происходит вызов функции `ProcessData`, в аргументах которой находятся следующие данные:

+ `"source_id"` - id источника. На основе id происходит выборка маппинга.
+ `"data_json"` - исходные данные с источника.
+ `"arrival_time"` - для статистики

На основе `"data_json"` создаётся JSON-документ, который затем и будет радактироваться.

## Как происходит получение маппинга?

Для получения маппинга используется монго. Подключение к монго происходит в файле `docker.py`.

Из монго происходит получение коллекции `'mappings'`, а затем её фильтрация по `"source_id"`. В результате получается необходимый список маппинов `"documents"`

## Что из себя представляет маппинг?

Маппинг представляет собой JSON-документ, содержащий информацию о необходимой структуре данных. Внутри маппинг состоит из следующих списков:

`{source_path:"путь_к_полю_данных_в_исходниках",  model_name:"новый_путь_к_этому_полю"}`

## Как происходит преобразование строк?

Прежде чем данные начнут обрабатываться, происходит преобразование строк согласно заданным правилам, описанным в маппинге, трансформациях и фильтрах.

### Преобразование маппинга:

На основе `"source_id"` производится выборка необходимых данных маппинга из базы данных MongoDB через коллекцию `'mappings'`.

Формат маппинга задаёт путь к полям исходных данных и новый путь, соответствующий структуре модели.

### Преобразование трансформаций:

Используется модуль `"transform.py"`. На основе описанных функций (например, `"yo"` для вычисления возраста или `"calculate"` для суммирования) происходит модификация данных.

+ Каждое преобразование определяется через поле `"field_path"` и функцию `"func'`, описанную в маппинге.

### Фильтрация данных:

Используется модуль `"filter.py"`. Фильтрация выполняется по заранее заданным условиям:

+ Например, сравнение значений (`"less"`, `"greater'`, `"equal"`) между полями или статическими значениями.

+ Данные, не прошедшие фильтр, исключаются из дальнейшей обработки.

## Как происходит передача данных?

После успешной обработки данные отправляются клиенту через `"run_client"`. Это реализовано с помощью gRPC-протокола, который использует сериализацию данных в формате `"protobuf"`.